name: Red-EyeJinn Capsule Sync

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install IPFS CLI
      run: |
        curl -L https://dist.ipfs.tech/kubo/v0.23.0/kubo_v0.23.0_linux-amd64.tar.gz -o kubo.tar.gz
        tar -xzf kubo.tar.gz
        sudo bash kubo/install.sh

    - name: Initialize IPFS
      run: |
        ipfs init
        ipfs config --json API.HTTPHeaders.Access-Control-Allow-Origin '["*"]'

    - name: Add repository to IPFS
      id: add_repo
      run: |
        CID=$(ipfs add -Qr .)
        echo "cid=$CID" >> $GITHUB_OUTPUT

    - name: Update capsule-history.json
      run: |
        CID="${{ steps.add_repo.outputs.cid }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        jq --arg cid "$CID" --arg ts "$TIMESTAMP" \
        '. += [{"cid": $cid, "label": "Auto-update", "timestamp": $ts}]' \
        capsule-history.json > capsule-history.tmp

        mv capsule-history.tmp capsule-history.json

    - name: Fetch mesh status
      run: |
        curl -s https://status.blackcorp.me/mesh.json -o mesh-status.json || echo "{}" > mesh-status.json

    - name: Commit and push updates
      run: |
        git config user.name "Red-EyeJinn Bot"
        git config user.email "actions@github.com"
        git add capsule-history.json mesh-status.json
        git commit -m "Auto-update capsule history and mesh status" || echo "No changes to commit"
        git push
